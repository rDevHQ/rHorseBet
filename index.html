<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horse Racing Data</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 0;
            color: #333;
        }

        header {
            background-color: #007bff;
            color: white;
            padding: 20px;
            text-align: center;
            font-size: 2rem;
            font-weight: bold;
        }

        .container {
            max-width: 1200px;
            margin: auto;
            padding: 20px;
        }

        .nav-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #0056b3;
        }

        h2 {
            margin-top: 40px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        .card {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        pre {
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        #download-json {
            display: none;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }
    </style>
</head>

<body>
    <header>Horse Racing Data</header>

    <div class="container">
        <div class="nav-buttons">
            <button id="prev-day"><</button>
            <p id="current-date"></p>
            <button id="next-day">></button>
        </div>

        <h2>Available Tracks</h2>
        <div class="grid" id="tracks"></div>

        <h2>Games for Selected Track</h2>
        <div class="grid" id="games"></div>

        <h2>Races for Selected Game</h2>
        <div class="grid" id="races"></div>

        <h2>Details</h2>
        <button id="download-json">Download JSON</button>
        <pre id="details"></pre>
    </div>

    <script type="module">
        import { transformRaces } from './transform.js';

        const apiCalendarUrl = 'https://www.atg.se/services/racinginfo/v1/api/calendar/day/';
        const gameApiBaseUrl = 'https://www.atg.se/services/racinginfo/v1/api/games/';
        let currentDate = new Date();

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        async function loadTracks(date) {
            const formattedDate = formatDate(date);
            document.getElementById('current-date').textContent = `${formattedDate}`;
            const response = await fetch(apiCalendarUrl + formattedDate);

            const tracksList = document.getElementById('tracks');
            tracksList.innerHTML = '';

            if (!response.ok) {
                tracksList.innerHTML = '<div class="card">Error loading tracks</div>';
                return;
            }

            const data = await response.json();

            data.tracks.forEach(track => {
                const div = document.createElement('div');
                div.classList.add('card');
                div.textContent = track.name;
                div.addEventListener('click', () => displayGamesForTrack(track, data.games));
                tracksList.appendChild(div);
            });
        }

        function displayGamesForTrack(track, gamesData) {
            const gamesList = document.getElementById('games');
            gamesList.innerHTML = '';

            const excludedTypes = ['plats', 'trio', 'komb', 'tvilling', 'vp', 'raket'];
            const gamesForTrack = [];

            Object.keys(gamesData).forEach(gameType => {
                gamesData[gameType].forEach(game => {
                    if (game.status === 'bettable' && game.tracks.includes(track.id) && !excludedTypes.includes(gameType.toLowerCase())) {
                        gamesForTrack.push({ type: gameType, ...game });
                    }
                });
            });

            gamesForTrack.forEach(game => {
                const div = document.createElement('div');
                div.classList.add('card');
                const gameTime = new Date(game.startTime).toLocaleTimeString('sv-SE', { hour: '2-digit', minute: '2-digit' });
                div.textContent = `${game.type} - ${gameTime}`;
                div.addEventListener('click', () => fetchGameDetails(game.id));
                gamesList.appendChild(div);
            });
        }

        async function fetchGameDetails(gameId) {
            const apiUrl = gameApiBaseUrl + gameId;
            try {
                const response = await fetch(apiUrl);
                const detailsContainer = document.getElementById('details');

                if (!response.ok) {
                    detailsContainer.textContent = 'Error loading game details';
                    return;
                }

                const data = await response.json();
                const races = data.races;
                const startsData = {};

                for (const race of races) {
                    for (const start of race.starts) {
                        const horseId = start.horse.id;
                        const raceId = race.id;
                        const startNumber = start.number;
                        const startApiUrl = `https://www.atg.se/services/racinginfo/v1/api/races/${raceId}/start/${startNumber}`;

                        try {
                            const startResponse = await fetch(startApiUrl);
                            if (startResponse.ok) {
                                const startData = await startResponse.json();
                                startsData[horseId] = startData;
                            }
                        } catch (error) {
                            console.error(`Error fetching starts data for horse ID ${horseId}:`, error);
                        }
                    }
                }

                const transformedRaces = transformRaces(races, startsData);
                displayRaces(transformedRaces);
                detailsContainer.textContent = JSON.stringify(transformedRaces, null, 2);

                const downloadButton = document.getElementById('download-json');
                downloadButton.style.display = 'block';
                downloadButton.onclick = () => downloadJSON(transformedRaces, `${gameId}.json`);

            } catch (error) {
                console.error('Error fetching game details:', error);
                document.getElementById('details').textContent = 'Error loading game details';
            }
        }

        function displayRaces(races) {
            const racesList = document.getElementById("races");
            racesList.innerHTML = "";

            races.forEach(race => {
                const div = document.createElement("div");
                div.classList.add("card");
                div.textContent = `Race ${race.number}`;
                div.addEventListener("click", () => displayRaceDetails(race));
                racesList.appendChild(div);
            });
        }

        function displayRaceDetails(race) {
            const detailsContainer = document.getElementById('details');
            detailsContainer.textContent = JSON.stringify(race, null, 2);

            const downloadButton = document.getElementById('download-json');
            downloadButton.style.display = 'block';
            downloadButton.onclick = () => downloadJSON(race, `${race.id}.json`);
        }

        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        document.getElementById('prev-day').addEventListener('click', () => {
            currentDate.setDate(currentDate.getDate() - 1);
            loadTracks(currentDate);
        });

        document.getElementById('next-day').addEventListener('click', () => {
            currentDate.setDate(currentDate.getDate() + 1);
            loadTracks(currentDate);
        });

        loadTracks(currentDate);
    </script>
</body>

</html>
